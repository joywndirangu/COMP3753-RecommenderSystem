<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Medlocator Administration</title>
        <link rel="stylesheet" href="main.css">
        <!-- need to change the css sheet to have it to work -->
    </head>
    <body>
        <header>
                <img src="RSLogo.png" alt="AcadiaPG">
        </header>
        <div class="navbar">
            <span id="open-btn" onclick="openNav()">☰</span>
            <a href="Home.html" class="right">Sign Out</a>
        </div>
        <div id="sideNav" class="sidenav">
            <a href="javascript:void(0)" class="closebtn" onclick="closeNav()">×</a>
            <a href="patientDB.html">Record Management</a>
            <a href="index.html">Site Finder</a>
            <a href="contactForm.html">Contact Us</a>
        </div>
        <main>
            <h1>MedLocator Management System</h1>
            <form id="create_pt" class="create_pt">
                <div class="container1">
                    <div class="container2">
                        <div class="container">
                            <section id="create_patient">
                                <h2>Create Patient</h2>
                                <p>Please fill in this form to create a patient.</p>
                                <label for="health_number"><b>Healthcard Number</b></label>
                                <input type="number" id="healthcard_no" placeholder="Healthcard Number" name="health_number" minlength="10" maxlength="10"required>
                                <label for="name"><b>Name</b></label>
                                <input type="text" id="patient_name" placeholder="Name" name="name" required>
                                <label for="sex"><b>Sex</b></label>
                                <input type="text" id="patient_sex" placeholder="Sex (M/F)" name="sex" required>
                                <label for="age"><b>Age</b></label>
                                <input type="number" id="patient_age" placeholder="Age" name="age" required>
                                <label for="address"><b>Patient Address</b></label>
                                <input type="text" id="patient_address" placeholder="Address" name="address" required>
                                <label for="emg_contact"><b>Emergency Contact Details:</b></label>
                                <br><br>
                                <label for="emg_contact"><b>Name</b></label>
                                <input type="text" id="emerg_contact" placeholder="Emergency Contact" name="emg_contact" required>
                                <label for="emg_contact"><b>Phone Number</b></label>
                                <input type="tel" id="phone" name="phone" placeholder="Enter your phone number" pattern="[0-9]{3}-[0-9]{3}-[0-9]{4}" required>
                                <label for="emg_contact"><b>Relationship</b></label>
                                <input type="text" id="emerg_contact" placeholder="Emergency Contact" name="emg_contact" required>
                                <button onclick="create_patient()" class="btn">Create Patient</button>
                            </section>
                        </div>
                        <section id="patients_section">
                            <h2>Patients</h2>
                            <div id="patients_container" style="height: 200px; overflow-y: scroll; border: 1px solid #ccc;">
                            </div>
                        </section>
                    </div>
                </div>
            </form>
        </main>
        <footer>
            <div class="footer">
                <h4>MEDLOCATOR</h4>
            </div>
            <div id = "copyright">
                <p>Copyright &copy; 2024 DBMS</p>
            </div>
        </footer>
    </body>
    <script>

        function openNav() {
            document.getElementById("sideNav").style.width = "250px";
            document.getElementById("main").style.marginLeft = "250px";
        }
    
        function closeNav() {
            document.getElementById("sideNav").style.width = "0";
            document.getElementById("main").style.marginLeft= "0";
        }

        function toggleForms(formIdToShow) {
            const forms = document.querySelectorAll('form');
            forms.forEach(form => {
                if (form.id === formIdToShow) {
                    form.style.display = 'block';
                } else {
                    form.style.display = 'none';
                }
            });
        }

        async function req(type, act, data) {
            try {

                const response = await fetch('https://localhost:4443/', {

                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },

                    credentials: 'include',

                    body: JSON.stringify({
                        'type': type,
                        'act': act,
                        'data': data,
                    }),
                });

                if (!response.ok) {
                    throw new Error('network response was not ok');
                }

                const contentType = response.headers.get('Content-Type');

                if (contentType && contentType.includes('application/json')) {
                    const json = await response.json();
                    console.log('Server responded with JSON:', json);
                    return json;
                } else {
                    const text = await response.text();
                    console.log('Server responded with plain text:', text);
                    return text;
                }
            } 

            catch (error) {
                console.error('There was a problem with your fetch operation:', error);
            }
            }

            function make_list(ulElement, item) {
            let liElement = document.createElement("li");
            liElement.textContent = item;
            liElement.style.display = "inline-block";
            liElement.style.marginRight = "10px";
            ulElement.appendChild(liElement);
            }

            req('retrieve', 'admin', null).then(admin => {

            document.getElementById('clinic_id').value = admin[1]
            document.getElementById('admin_role').value = admin[2]
            document.getElementById('admin_name').value = admin[3]
            document.getElementById('admin_email').value = admin[4]
            document.getElementById('admin_password').value = '**********'

            try{

                const pnts = JSON.parse(admin[6]);

                for (let i = 0; i < pnts.length; i++) {

                    let divElement = document.createElement('div');
                    let ulElement = document.createElement('ul');

                    req('retrieve', 'patient', [pnts[i]]).then(patient_items => {
                        patient_items.forEach(function(item) {
                            make_list(ulElement, item);
                        });

                        let deleteElementButton = document.createElement('button');
                        
                        deleteElementButton.onclick = function() {
                            req('delete', 'patient', [pnts[i]]).then(function(){
                                location.reload(true);
                            });
                        };

                        ulElement.appendChild(deleteElementButton);

                        deleteElementButton.style.backgroundColor = 'red';
                        deleteElementButton.style.color = 'white';
                        deleteElementButton.textContent = 'X';
                        deleteElementButton.style.display = 'inline-block';

                        divElement.appendChild(ulElement);
                        document.getElementById('patients_container').appendChild(divElement);
                    });
                }

                for (let i = 0; i < pnts.length; i++) {

                    req('retrieve', 'appointment', [pnts[i]]).then(appointments => {

                        appointments.forEach(function(appointment_items) {

                            let divElement = document.createElement("div");
                            let ulElement = document.createElement("ul");

                            appointment_items.forEach(function(item) {
                                make_list(ulElement, item);
                            });

                            let deleteElementButton = document.createElement('button');
                        
                            deleteElementButton.onclick = function() {
                                req('delete', 'patient', [pnts[i]]).then(function(){
                                    location.reload(true);
                                });
                            };

                            ulElement.appendChild(deleteElementButton);

                            deleteElementButton.style.backgroundColor = 'red';
                            deleteElementButton.style.color = 'white';
                            deleteElementButton.textContent = 'X';
                            deleteElementButton.style.display = 'inline-block';

                            divElement.appendChild(ulElement);
                            document.getElementById('appointments_container').appendChild(divElement);

                        });
                    });
                }

                for (let i = 0; i < pnts.length; i++) {

                    req('retrieve', 'medical_record', [pnts[i]]).then(records => {

                        records.forEach(function(record_items) {

                            let divElement = document.createElement("div");
                            let ulElement = document.createElement("ul");

                            record_items.forEach(function(item) {
                                make_list(ulElement, item)
                            });

                            let deleteElementButton = document.createElement('button');
                        
                            deleteElementButton.onclick = function() {
                                req('delete', 'patient', [pnts[i]]).then(function(){
                                    location.reload(true);
                                });
                            };

                            ulElement.appendChild(deleteElementButton);

                            deleteElementButton.style.backgroundColor = 'red';
                            deleteElementButton.style.color = 'white';
                            deleteElementButton.textContent = 'X';
                            deleteElementButton.style.display = 'inline-block';

                            divElement.appendChild(ulElement);
                            document.getElementById('medical_records_container').appendChild(divElement);
                        });
                    });
                }
            } catch (error) {

                console.error('failed to parse patient list: ', error);
            }
            });

            function update_admin() {
            req('retrieve', 'admin', null).then(admin => {
                console.log(req('update', 'admin', [
                    parseInt(document.getElementById('clinic_id').value),
                    document.getElementById('admin_role').value,
                    document.getElementById('admin_name').value,
                    document.getElementById('admin_email').value,
                    document.getElementById('admin_password').value,
                    // document.getElementById('admin_old_password').value,
                    // document.getElementById('admin_new_password').value,
                    admin[6],
                    admin[0]
                ]));
            });
            window.location.href = 'patientDB.html';
            }

            function create_patient() {
            console.log(req('create', 'patient', [
                document.getElementById('patient_name').value,
                document.getElementById('patient_sex').value,
                parseInt(document.getElementById('patient_age').value),
                document.getElementById('emerg_contact').value,
                parseInt(document.getElementById('healthcard_no').value),
                document.getElementById('patient_address').value
            ]));
            window.location.href = 'patientDB.html';
            }

            function create_appointment() {
            console.log(req('create', 'appointment', [
                parseInt(document.getElementById('appointment_patient_id').value),
                document.getElementById('appointment_type').value,
                document.getElementById('appointment_status').value,
                document.getElementById('appointment_datetime').value
            ]));
            window.location.href = 'patientDB.html';
            }

            function create_medical_record() {
            console.log(req('create', 'medical_record', [
                parseInt(document.getElementById('record_patient_id').value),
                document.getElementById('diagnoses').value,
                document.getElementById('med_hist').value,
                document.getElementById('medication').value
            ]));
            window.location.href = 'patientDB.html';
            }

    </script>
</html>